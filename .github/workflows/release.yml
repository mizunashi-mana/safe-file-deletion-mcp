name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (skip tag push and npm publish)'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: ./.github/actions/setup-devenv

      - name: Get version from package.json
        id: version
        run: |
          VERSION="$(node -p 'require("./package.json").version')"
          echo "Version from package.json: $VERSION"

          # Check if tag already exists
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Error: Tag v$VERSION already exists"
            exit 1
          fi

          # Set output
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run tests
        run: devenv shell npm test

      - name: Build package
        run: devenv shell npm run build

      - name: Dry run check
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "🔍 DRY RUN MODE - The following actions will be skipped:"
          echo "  - Publishing to npm"
          echo "  - Creating and pushing git tag"
          echo ""
          echo "📦 Package would be published:"
          echo "  Name: $(node -p "require('./package.json').name")"
          echo "  Version: ${{ steps.version.outputs.version }}"
          echo "  Tag: ${{ steps.version.outputs.tag }}"

      - name: Publish to npm
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: devenv shell npm publish

      - name: Create and push tag
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Summary
        run: |
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "✅ Dry run completed successfully"
            echo "  - Tests passed"
            echo "  - Build completed"
            echo "  - Ready to release version ${{ steps.version.outputs.version }}"
          else
            echo "🚀 Release completed successfully"
            echo "  - Published version ${{ steps.version.outputs.version }} to npm"
            echo "  - Created and pushed tag ${{ steps.version.outputs.tag }}"
          fi
